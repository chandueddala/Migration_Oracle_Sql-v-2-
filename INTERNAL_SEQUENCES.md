# Internal Oracle Identity Sequences

## Overview

Oracle 12c and later versions use **internal identity sequences** with the naming pattern `ISEQ$$_%` to implement IDENTITY columns. These sequences are automatically created by Oracle when you define a column with the `GENERATED ALWAYS AS IDENTITY` or `GENERATED BY DEFAULT AS IDENTITY` clause.

## Detection

Internal identity sequences are identified by their naming pattern:
- **Pattern**: `ISEQ$$_%` (starts with `ISEQ$$_` followed by a unique identifier)
- **Purpose**: Auto-generated by Oracle to support IDENTITY column functionality
- **Visibility**: Appear in `USER_SEQUENCES` view but should not be migrated as standalone sequences

## How They're Handled

### During Discovery

The migration tool automatically filters out internal identity sequences:

1. **Query Filtering**: Discovery queries exclude sequences matching `ISEQ$$_%`
   ```sql
   SELECT sequence_name FROM user_sequences 
   WHERE sequence_name NOT LIKE 'ISEQ$$_%'
   ```

2. **Logging**: When internal sequences are found, the tool logs:
   ```
   ⏭️  Found N internal Oracle identity sequence(s) - will be handled via IDENTITY columns
   ```

### During DDL Generation

When attempting to get DDL for an internal sequence:

1. **Name Check**: The tool checks if the sequence name starts with `ISEQ$$_`
2. **Skip Message**: Returns a skip message instead of attempting DDL generation
3. **ORA-31603 Handling**: Catches and handles this error gracefully if it occurs

### During Table Migration

Tables with IDENTITY columns in Oracle are properly handled:

1. **Column Detection**: Oracle IDENTITY columns are detected during table analysis
2. **SQL Server Mapping**: Mapped to SQL Server IDENTITY columns (not SEQUENCE objects)
3. **DDL Generation**: Target table DDL includes proper IDENTITY column syntax

### During Data Migration

The tool handles IDENTITY columns during data load:

1. **IDENTITY_INSERT ON**: Enabled before data insertion
   ```sql
   SET IDENTITY_INSERT [schema].[table] ON;
   ```

2. **Data Load**: Existing ID values are preserved

3. **IDENTITY_INSERT OFF**: Disabled after data insertion
   ```sql
   SET IDENTITY_INSERT [schema].[table] OFF;
   ```

4. **Reseeding**: IDENTITY column is reseeded to MAX(id) + 1
   ```sql
   DBCC CHECKIDENT ('[schema].[table]', RESEED, @MaxID + 1);
   ```

## Example Scenario

### Oracle Database

```sql
-- Create table with IDENTITY column
CREATE TABLE employees (
    employee_id NUMBER GENERATED ALWAYS AS IDENTITY,
    name VARCHAR2(100)
);
```

Oracle automatically creates a sequence like `ISEQ$$_12345` to support this IDENTITY column.

### Migration Process

1. **Discovery**: 
   - Tool finds `ISEQ$$_12345` but filters it out
   - Logs: "Found 1 internal Oracle identity sequence(s)"
   - Reports: "0 user-created sequences"

2. **Table Migration**:
   - Analyzes `employees` table structure
   - Detects IDENTITY column on `employee_id`
   - Generates SQL Server DDL:
     ```sql
     CREATE TABLE [dbo].[employees] (
         employee_id INT IDENTITY(1,1) NOT NULL,
         name NVARCHAR(100)
     );
     ```

3. **Data Migration**:
   - Enables `IDENTITY_INSERT ON`
   - Migrates data preserving existing IDs
   - Disables `IDENTITY_INSERT OFF`
   - Reseeds IDENTITY to continue from MAX(employee_id) + 1

## Troubleshooting

### ORA-31603 Error

**Error Message**:
```
ORA-31603: object "ISEQ$$_12345" of type SEQUENCE not found in schema "USER"
```

**Cause**: Attempting to get DDL via `DBMS_METADATA.GET_DDL` for an internal sequence that Oracle doesn't allow direct access to.

**Resolution**: The migration tool now catches this error and logs it as an informational message. No action needed.

**Log Example**:
```
⏭️  Skipping sequence ISEQ$$_12345 (ORA-31603 - likely internal identity sequence)
```

### No Sequences Found

**Scenario**: Discovery reports "No sequences found" but you know there are sequences.

**Check**:
1. Verify the sequences aren't all internal: 
   ```sql
   SELECT sequence_name FROM user_sequences WHERE sequence_name NOT LIKE 'ISEQ$$_%';
   ```
2. Check logs for "Found N internal Oracle identity sequence(s)" message

**Resolution**: If all sequences are internal, this is expected behavior. The IDENTITY columns will be migrated correctly.

### IDENTITY Column Not Working in SQL Server

**Symptoms**: After migration, you can't insert rows without specifying IDs.

**Check**:
1. Verify the column was created with IDENTITY:
   ```sql
   SELECT COLUMN_NAME, DATA_TYPE 
   FROM INFORMATION_SCHEMA.COLUMNS 
   WHERE COLUMNPROPERTY(OBJECT_ID(TABLE_SCHEMA + '.' + TABLE_NAME), 
                        COLUMN_NAME, 'IsIdentity') = 1;
   ```

2. Check if IDENTITY was properly reseeded:
   ```sql
   DBCC CHECKIDENT ('[dbo].[table_name]');
   ```

**Resolution**: 
- If IDENTITY is missing, the table migration may have failed. Review migration logs.
- If reseeding is incorrect, manually reseed: `DBCC CHECKIDENT ('[dbo].[table_name]', RESEED, N);`

## Best Practices

### Pre-Migration

1. **Identify IDENTITY Columns**: Query Oracle to find tables with IDENTITY columns:
   ```sql
   SELECT table_name, column_name, identity_options
   FROM all_tab_identity_cols
   WHERE owner = USER;
   ```

2. **Document Custom Sequences**: Ensure you understand which sequences are custom (user-created) vs internal (auto-generated)

### During Migration

1. **Review Logs**: Check for internal sequence detection messages
2. **Verify IDENTITY Columns**: Confirm IDENTITY columns are created correctly in SQL Server
3. **Test Data Load**: Verify IDENTITY_INSERT handling works correctly

### Post-Migration

1. **Test Auto-Increment**: Insert new rows and verify IDs auto-increment correctly
2. **Check Seed Values**: Verify IDENTITY columns start from the correct value
3. **Validate Data**: Ensure all existing IDs were preserved during migration

## Related Components

- **oracle_connector.py** - `get_sequence_ddl()` method handles internal sequence detection
- **comprehensive_discovery.py** - `_discover_sequences()` filters internal sequences
- **automatic_migration.py** - `_migrate_sequences_automatic()` reports completion status
- **sqlserver_connector.py** - `set_identity_insert()` and `bulk_insert_data()` handle data loading
- **identity_converter.py** - Manages IDENTITY column conversion and reseeding

## References

- [Oracle IDENTITY Columns Documentation](https://docs.oracle.com/en/database/oracle/oracle-database/19/sqlrf/CREATE-TABLE.html#GUID-F9CE0CC3-13AE-4744-A43C-EAC7A71AAAB6__CJAEJGCE)
- [SQL Server IDENTITY Columns](https://docs.microsoft.com/en-us/sql/t-sql/statements/create-table-transact-sql-identity-property)
- [Oracle DBMS_METADATA Package](https://docs.oracle.com/en/database/oracle/oracle-database/19/arpls/DBMS_METADATA.html)
